<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Therapy Support</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:2rem;color:#111;background:#fff}
    @media (prefers-color-scheme: dark){
      body{color:#eaeaea;background:#111}
    }
    .card{max-width:820px;margin:auto;padding:1.25rem;border:1px solid #ddd;border-radius:12px;background:transparent}
    .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    textarea{width:100%;min-height:120px;font-size:1rem;padding:.75rem;border-radius:10px;border:1px solid #bbb;background:#fff;color:#111}
    @media (prefers-color-scheme: dark){
      textarea{background:#1b1b1b;color:#eaeaea;border-color:#333}
    }
    input[type="text"],input[type="password"]{width:100%;max-width:560px;padding:.55rem .65rem;border-radius:8px;border:1px solid #ccc;background:#fff;color:#111}
    @media (prefers-color-scheme: dark){
      input[type="text"],input[type="password"]{background:#1b1b1b;color:#eaeaea;border-color:#333}
    }
    button{padding:.6rem 1rem;border-radius:10px;border:1px solid #666;cursor:pointer;background:transparent}
    .out{
      white-space:pre-wrap;
      background:#f9f9f9; color:#111;
      padding:1rem;border:1px solid #ccc;border-radius:10px;min-height:3rem
    }
    .out:empty::before{content:"Response will appear here…"; color:#777}
    @media (prefers-color-scheme: dark){
      .out{background:#1b1b1b;color:#eaeaea;border-color:#333}
      .out:empty::before{color:#888}
    }
    .pill{font-size:.85rem;padding:.25rem .6rem;border-radius:999px;border:1px solid #ccc}
    .pill.ok{color:#2b7a0b;border-color:#2b7a0b40}
    .pill.warn{color:#b45309;border-color:#b4530940}
    .muted{color:#666;font-size:.9rem}
    .sep{height:1px;background:#e6e6e6;margin:1rem 0}
    .small{font-size:.9rem}
    code{padding:.1rem .35rem;border:1px solid #e5e5e5;border-radius:6px;background:#fafafa}
    @media (prefers-color-scheme: dark){
      .muted{color:#9a9a9a}
      code{background:#151515;border-color:#2a2a2a}
      .sep{background:#2a2a2a}
      .card{border-color:#2a2a2a}
      button{border-color:#888}
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Therapy Support</h2>
    <p class="small muted">Supportive information only — <b>not a replacement for professional care</b>.</p>

    <!-- Connection controls -->
    <h3>Connection</h3>
    <div class="row">
      <label for="apiUrl"><b>API URL</b></label>
      <input id="apiUrl" type="text" placeholder="https://<your-tunnel>.trycloudflare.com/fallback"/>
      <button id="useLocal">Use Local</button>
      <button id="useTunnel">Use Tunnel</button>
    </div>
    <div class="row small muted">
      <div>• Local dev: <code>http://127.0.0.1:8000/fallback</code></div>
      <div>• Cloudflare Tunnel: <code>https://&lt;random&gt;.trycloudflare.com/fallback</code></div>
    </div>
    <div class="row" style="margin-top:.4rem">
      <label for="auth"><b>Auth (optional)</b></label>
      <input id="auth" type="password" placeholder="shared token if enabled on agent"/>
      <button id="saveCfg">Save</button>
      <span id="cfgStatus" class="pill"></span>
    </div>

    <div class="sep"></div>

    <!-- Chat UI -->
    <label for="q"><b>What’s on your mind?</b></label>
    <textarea id="q" placeholder="Type here... (⌘/Ctrl + Enter to send)"></textarea>
    <div class="row" style="margin-top:.6rem">
      <button id="askBtn">Ask</button>
      <span id="status" class="pill ok">ready</span>
    </div>

    <h3>Response</h3>
    <div id="resp" class="out"></div>
    <p id="log" class="muted small"></p>
  </div>

  <script>
    // Persist configuration in localStorage so you can switch endpoints without redeploy
    const DEFAULTS = {
      API_URL: "http://127.0.0.1:8000/fallback",  // local agent
      AUTH: ""                                     // e.g., "supersecret"
    };
    const LS_KEY = "therapy_support_cfg_v1";
    function loadCfg(){ try { return {...DEFAULTS, ...(JSON.parse(localStorage.getItem(LS_KEY))||{})}; } catch { return {...DEFAULTS}; } }
    function saveCfg(cfg){ localStorage.setItem(LS_KEY, JSON.stringify(cfg)); }

    const cfg = loadCfg();

    // DOM refs
    const qEl = document.getElementById("q");
    const btn = document.getElementById("askBtn");
    const resp = document.getElementById("resp");
    const st = document.getElementById("status");
    const log = document.getElementById("log");
    const apiUrlEl = document.getElementById("apiUrl");
    const authEl = document.getElementById("auth");
    const saveCfgBtn = document.getElementById("saveCfg");
    const useLocalBtn = document.getElementById("useLocal");
    const useTunnelBtn = document.getElementById("useTunnel");
    const cfgStatus = document.getElementById("cfgStatus");

    apiUrlEl.value = cfg.API_URL;
    authEl.value = cfg.AUTH || "";

    function setStatus(text, type=""){ st.textContent=text; st.className="pill "+(type||""); }
    function setCfgStatus(text, type=""){ cfgStatus.textContent=text; cfgStatus.className="pill "+(type||""); }

    async function ask(){
      const text = (qEl.value||"").trim();
      if(!text){ resp.textContent="Please type a message."; setStatus("idle",""); return; }
      btn.disabled = true;
      setStatus("Thinking…","warn");
      resp.textContent = ""; log.textContent = "";

      try{
        const headers = { "Content-Type": "application/json" };
        if ((cfg.AUTH||"").trim()) headers["Authorization"] = "Bearer " + cfg.AUTH.trim();

        const r = await fetch(cfg.API_URL, { method: "POST", headers, body: JSON.stringify({ text }) });
        if (!r.ok) { const t = await r.text(); throw new Error(`HTTP ${r.status} – ${t}`); }

        const data = await r.json();
        setStatus(
          data.mode === "llm" ? "local model" :
          data.mode === "crisis" ? "crisis" :
          (data.mode || "ok"),
          data.mode === "llm" ? "ok" : "warn"
        );
        resp.textContent = data.text || "(no text)";
        log.textContent = `Endpoint: ${cfg.API_URL}`;
      } catch (e){
        setStatus("cannot reach agent","warn");
        resp.textContent = "Could not reach your agent. Ensure it’s running and the URL is correct.";
        log.textContent = String(e);
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener("click", ask);
    qEl.addEventListener("keydown", (e) => { if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) ask(); });

    useLocalBtn.addEventListener("click", ()=>{ apiUrlEl.value = "http://127.0.0.1:8000/fallback"; });
    useTunnelBtn.addEventListener("click", ()=>{
      apiUrlEl.value = "https://<your-tunnel-subdomain>.trycloudflare.com/fallback";
      apiUrlEl.focus(); apiUrlEl.select();
    });

    saveCfgBtn.addEventListener("click", ()=>{
      const newCfg = { API_URL: apiUrlEl.value.trim(), AUTH: authEl.value.trim() };
      if(!newCfg.API_URL){ setCfgStatus("missing API URL","warn"); return; }
      saveCfg(newCfg); Object.assign(cfg, newCfg);
      setCfgStatus("saved","ok"); setTimeout(()=> setCfgStatus("", ""),1500);
    });

    setStatus("ready","ok");
  </script>
</body>
</html>
